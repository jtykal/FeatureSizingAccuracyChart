<!DOCTYPE html>
<html>
<head>
    <title>Feature Sizing Accuracy Chart</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Calculator",{prepareChartData:function(t){var e=this._groupData(t.getRange()),n=_.keys(e),r=_.transform(e,function(t,e,n){t[n]=this._gatherTotals(e)},{},this);return{categories:n,series:[{name:"Leaf Story Plan Estimate Total (Mean)",type:"column",data:_.map(r,function(t,e){return[e,this._computeMean(t)]},this)},{name:"P25 - P75",type:"errorbar",data:_.map(r,function(t){return this._computePercentiles(t)},this),showInLegend:!0}]}},_computeMean:function(t){var e=_.reduce(t,function(t,e){return t+e},0);return Math.round(e/t.length)},_gatherTotals:function(t){return _.sortBy(_.map(t,function(t){return t.get("LeafStoryPlanEstimateTotal")}))},_computePercentiles:function(t){var e=this._computePercentile(.25,t),n=this._computePercentile(.75,t);return e===n?[]:[e,n]},_computePercentile:function(t,e){var n=t*e.length,r=Math.floor(n);return 1===e.length?e[0]:r===n?(e[r]+e[r-1])/2:e[r]},_groupData:function(t){return _.groupBy(t,function(t){return t.get("PreliminaryEstimate").Name})}});
                Ext.define("FeatureSizingAccuracyChartApp",{extend:"Rally.app.App",componentCls:"app",layout:"fit",autoScroll:!1,requires:["Calculator"],config:{defaultSettings:{query:""}},getSettingsFields:function(){return[{type:"query"}]},launch:function(){console.log("Ext.isIE9 is...",Ext.isIE9),Rally.data.wsapi.ModelFactory.getModel({type:"PortfolioItem"}).then({success:this._loadMetadata,scope:this})},_getLowestLevelPI:function(){return console.log("_getLowestLevelPI"),Ext.create("Rally.data.wsapi.Store",{model:"TypeDefinition",filters:[{property:"Creatable",value:!0},{property:"Parent.Name",value:"Portfolio Item"},{property:"Ordinal",value:0}]}).load().then({success:function(e){return e[0].get("TypePath")},scope:this})},_loadMetadata:function(e){return this.model=e,console.log("_loadMetadata:  this.model=",this.model),this._getLowestLevelPI().then({success:this._onMetaRetrieved,scope:this})},_onMetaRetrieved:function(e){console.log("_onMetaRetrieved, piType=",e),this.piType=e,this._addChart()},_addChart:function(){console.log("_addChart");var e=this.getContext(),t=["Milestones","Tags"],o={xtype:"rallygridboard",toggleState:"chart",chartConfig:this._getChartConfig(),plugins:[{ptype:"rallygridboardinlinefiltercontrol",showInChartMode:!0,inlineFilterButtonConfig:{stateful:!0,stateId:e.getScopedStateId("filters"),filterChildren:!1,modelNames:["portfolioitem/feature"],inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:["Release"],addQuickFilterConfig:{whiteListFields:t}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{whiteListFields:t}}}}}}],context:e,modelNames:["portfolioitem/feature"],storeConfig:{filters:this._getFilters()}};this.add(o)},_getChartConfig:function(){return console.log("_getChartConfig"),{xtype:"rallychart",chartColors:["#FF8200","#F6A900","#FAD200","#8DC63F","#1E7C00","#337EC6","#005EB8","#7832A5","#DA1884","#C0C0C0"],storeType:"Rally.data.wsapi.Store",storeConfig:{context:this.getContext().getDataContext(),limit:1/0,fetch:this._getChartFetch(),sorters:this._getChartSort(),pageSize:2e3,model:"PortfolioItem/Feature"},calculatorType:"Calculator",calculatorConfig:{sizes:this.sizes},chartConfig:{chart:{type:"column"},legend:{enabled:!0},title:{text:""},yAxis:{min:0,title:{text:this.getContext().getWorkspace().WorkspaceConfiguration.ReleaseEstimateUnitName}},plotOptions:{column:{dataLabels:{enabled:!1},colorByPoint:!0}}}}},onTimeboxScopeChange:function(){console.log("onTimeboxScopeChange"),this.callParent(arguments);var e=this.down("rallygridboard");e&&e.destroy(),this._addChart()},_getChartFetch:function(){return console.log("_getChartFetch"),["PreliminaryEstimate","Name","Value","LeafStoryPlanEstimateTotal","Release"]},_getChartSort:function(){return console.log("_getChartSort"),[{property:"PreliminaryEstimateValue",direction:"ASC"}]},_getFilters:function(){console.log("_getFilters");var e=[{property:"PreliminaryEstimate",operator:"!=",value:null}],t=this.getContext().getTimeboxScope();return console.log("timeboxScope is",t),t&&t.isApplicable(this.model)&&(console.log("timeboxScope IS APPLICABLE"),e.push(t.getQueryFilter())),this.getSetting("query")&&e.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),console.log("_getFilters - queries =",e),e}});

            Rally.launchApp('FeatureSizingAccuracyChartApp', {
                name:"Feature Sizing Accuracy Chart",
                parentRepos:"",
                version:"1.0.0"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
